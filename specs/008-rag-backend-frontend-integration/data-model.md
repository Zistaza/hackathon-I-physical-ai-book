# Data Model: RAG Backend Frontend Integration

## Entities

### QueryRequest
Represents a user's question and context from the frontend

**Fields**:
- `id: str` (optional) - Unique identifier for the query, generated if not provided
- `question: str` - The user's question text
- `selected_text_only: bool` - Whether to restrict search to selected text only (default: false)
- `selected_text_content: str` (optional) - The specific text content to search within when selected_text_only is true
- `session_id: str` (optional) - Session identifier for conversation tracking
- `metadata: Dict[str, Any]` (optional) - Additional metadata for the query

**Validation rules**:
- `question` must be non-empty string
- If `selected_text_only` is true, `selected_text_content` must be provided and non-empty

### QueryResponse
Represents the response from the RAG agent to the frontend

**Fields**:
- `id: str` - Unique identifier for the response
- `answer: str` - The final answer generated by the RAG agent
- `citations: List[Citation]` - List of sources used to generate the answer
- `retrieved_chunks: List[RetrievedChunk]` - Details of chunks used in the response
- `refusal_reason: str` (optional) - Reason if the query was refused (e.g., "not found in book")
- `deterministic_hash: str` (optional) - Hash for verifying determinism
- `timestamp: float` - Unix timestamp of response generation
- `session_id: str` (optional) - Session identifier if provided in request

**Validation rules**:
- `answer` must be non-empty string when no refusal
- `citations` and `retrieved_chunks` should match content in the answer

### Citation
Represents a source citation for content in the response

**Fields**:
- `source_url: str` - URL of the source document
- `module: str` - Module identifier from the book
- `chapter: str` - Chapter identifier from the book
- `section: str` (optional) - Section identifier if available

**Validation rules**:
- At least one of `source_url`, `module`, or `chapter` must be provided

### RetrievedChunk
Represents a content chunk retrieved from the vector store

**Fields**:
- `text: str` - The actual text content retrieved
- `score: float` - Similarity score (0.0 to 1.0)
- `source_url: str` - URL of the source document
- `module: str` - Module identifier from the book
- `chapter: str` - Chapter identifier from the book
- `chunk_index: int` - Index of the chunk within the source

**Validation rules**:
- `score` must be between 0.0 and 1.0
- `text` must be non-empty

### HealthResponse
Represents the system health status

**Fields**:
- `status: str` - Overall system status ("healthy", "degraded", "unhealthy")
- `timestamp: float` - Unix timestamp of check
- `dependencies: Dict[str, bool]` - Status of individual dependencies (Qdrant, OpenAI API, etc.)
- `version: str` - API version

**Validation rules**:
- `status` must be one of the allowed values
- `dependencies` must include at least Qdrant status

## State Transitions

### Query Processing Flow
1. `QueryRequest` received → Validation → Processing
2. Processing → Retrieval → Agent Generation → Response Formation
3. Response Formation → `QueryResponse` returned

### Health Check Flow
1. Health request received → Dependency checks → Status aggregation
2. Status aggregation → `HealthResponse` returned

## Relationships

- `QueryRequest` → (processed by) → `QueryResponse`
- `QueryResponse` contains multiple → `Citation`
- `QueryResponse` contains multiple → `RetrievedChunk`
- `RetrievedChunk` has source reference → Book content in Qdrant